---
import { Code } from 'astro:components'
import Layout from '../layouts/Layout.astro'

const workflowCode = `- name: Build & push
  uses: docker/build-push-action@v6
  with:
    push: true
    tags: ghcr.io/you/my-api:\${{ github.sha }}

- name: Deploy via RollHook
  run: |
    curl -sf -X POST \\
      -H "Authorization: Bearer \${{ secrets.WEBHOOK_TOKEN }}" \\
      -H "Content-Type: application/json" \\
      -d '{"image_tag":"ghcr.io/you/my-api:\${{ github.sha }}"}' \\
      \${{ secrets.ROLLHOOK_URL }}/deploy/my-api`

const configCode = `# yaml-language-server: $schema=https://cdn.jsdelivr.net/npm/rollhook/schema/config.json
apps:
  - name: my-api
    compose_path: /srv/stacks/my-api/compose.yml
    steps:
      - service: backend

notifications:
  webhook: https://hooks.example.com/deployments`

const composeCode = `services:
  backend:
    image: \${IMAGE_TAG:-ghcr.io/you/my-api:latest}
    healthcheck:
      test: [CMD, curl, -f, http://localhost:3000/health]
      interval: 5s
      start_period: 10s
      retries: 5
    # No ports: — proxy routes via Docker DNS (backend:3000)
    # No container_name: — fixed names block docker-rollout from scaling
    # Works with Caddy, Traefik, nginx, or any reverse proxy
    networks:
      - proxy

networks:
  proxy:
    external: true`
---

<Layout
  title="RollHook — Zero-downtime rolling Docker Compose deployments via webhooks"
  description="Webhook-triggered rolling deployments for Docker Compose on VPS. Self-hosted, infra-as-code, integrates with GitHub Actions in minutes."
>
  <div class="min-h-screen flex flex-col">
    <main class="flex-1">
      <!-- Hero -->
      <section class="px-6 pt-14 pb-20 sm:pt-16 sm:pb-26">
        <div class="max-w-3xl mx-auto text-center space-y-6">
          <div class="flex items-center justify-center gap-3 mb-2">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 406 564"
              class="h-18 w-auto fill-foreground"
              aria-hidden="true"
            >
              <path
                d="M217.05 59.414 219 61v2h2c9.975 12.162 13.04 23.444 12 39-1.781 10.881-8.423 21.74-17.027 28.621-3.942 2.778-7.66 4.7-12.223 6.254-6.915 2.664-8.444 7.207-11.355 13.71a576 576 0 0 0-2.67 6.146A214 214 0 0 1 183.5 170a252 252 0 0 0-7 15c-2.691 6.271-5.653 12.354-8.75 18.438-2.449 4.985-4.62 10.071-6.781 15.187-1.626 3.727-3.446 7.34-5.281 10.969-3.638 7.197-6.937 14.526-10.188 21.906-3.777 8.574-7.69 17.027-11.953 25.367-1.945 3.938-3.6 7.96-5.238 12.031-1.191 2.823-2.494 5.566-3.845 8.315-6.937 14.235-11.052 29.17-13.464 44.787l-.559 3.309c-3.196 26.727 1.857 55.753 17.829 77.828 2.165 2.704 4.4 5.3 6.73 7.863l1.633 1.879c15.176 16.434 38.24 26.263 60.383 27.46 28.72.872 53.883-9.07 74.797-28.651 5.068-5.264 8.635-11.34 12.187-17.688l1.434-2.457c2.807-5.133 4.626-10.464 6.316-16.043l.64-2.085c2.745-9.557 2.75-19.162 2.673-29.04l-.014-3.332q-.018-4.021-.049-8.043c-4.359 1.366-8.412 3.043-12.535 5.004l-3.701 1.744q-2.878 1.364-5.754 2.732-2.801 1.33-5.608 2.649l-3.36 1.596c-2.723 1.141-5.134 1.831-8.042 2.275 1.64-5.95 4.632-11.027 7.625-16.375 3.552-6.426 7.074-12.848 10.313-19.437a1053 1053 0 0 1 24.31-46.345c3.218-5.807 6.2-11.692 9.127-17.652 2.647-5.198 5.617-10.196 8.625-15.191l1.703-2.84L319 249l2 1c.566 2.992 1.001 5.92 1.367 8.938l.363 2.817c.392 3.08.77 6.162 1.145 9.245l.396 3.21a3410 3410 0 0 1 2.363 19.69q.51 4.31 1.034 8.62c2.375 19.764 3.718 39.381 3.832 59.293l.032 2.795c.326 36.557-12.13 68.907-37.782 95.08-23.538 23.275-55.969 37.057-89.167 37.332-5.216-.105-10.395-.492-15.583-1.02l-3.383-.344c-33.218-4.329-62.416-21.542-83.281-47.539-24.282-32.403-32.435-70.55-26.993-110.646C78.733 315 85.92 294.752 95 274l1.512-3.473c4.974-11.4 9.961-22.765 15.652-33.828 2.586-5.114 4.904-10.357 7.273-15.574 3.385-7.448 6.855-14.823 10.574-22.109 2.833-5.596 5.417-11.296 7.989-17.016 2.905-6.458 5.862-12.87 9.063-19.187l.948-1.887c1.4-2.783 2.804-5.565 4.223-8.34a783 783 0 0 0 3.828-7.649l1.233-2.381c2.39-4.884 3.399-8.134 1.705-13.556-1.845-2.558-1.845-2.558-4.25-4.75-8.424-8.852-10.98-18.775-12.062-30.687C143.645 82.646 147.228 71.04 155 63h2v-2c19.042-14.29 40.099-14.622 60.05-1.586M179 87c-2.701 4.052-2.762 7.243-2 12 1.283 3.008 2.315 3.809 5 6 4.284 1.371 7.704 1.535 11.875-.187 3.875-3.222 3.875-3.222 5.445-7.895.201-4.037.032-6.327-2.07-9.856-3.103-2.844-4.94-3.891-9.125-4.437-3.97.476-6.02 1.905-9.125 4.375"
              ></path>
            </svg>
          <h1 class="text-6xl font-bold tracking-tight">RollHook
          </h1>
          </div>

          <h2 class="text-lg text-muted-foreground max-w-xl mx-auto leading-relaxed">
              Zero-downtime rolling Docker Compose deployments via webhooks.
          </h2>

          <div class="flex items-center justify-center gap-4 mt-6 pt-2">
            <a
              href="https://github.com/jkrumm/rollhook"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 rounded-md bg-foreground text-background px-5 py-2.5 text-sm font-medium hover:bg-foreground/90 transition-colors"
            >
              <svg viewBox="0 0 16 16" class="h-4 w-4 fill-current" aria-hidden="true">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
              </svg>
              GitHub
            </a>
            <a
              href="#how-it-works"
              class="inline-flex items-center gap-2 rounded-md border border-border px-5 py-2.5 text-sm font-medium hover:bg-muted/50 transition-colors"
            >
              How it works &darr;
            </a>
          </div>
        </div>
      </section>

      <!-- Code Showcase -->
      <section class="px-6 pb-20">
        <div class="max-w-5xl mx-auto">
          <div class="text-center mb-12">
            <h2 class="text-2xl font-semibold">Three files. That's the integration.</h2>
            <p class="text-muted-foreground mt-3 text-sm max-w-xl mx-auto">
              Your CI workflow, a server config, and a compose file — nothing else needed.
            </p>
          </div>
          <div class="grid grid-cols-1 gap-8">
            <!-- 1: GitHub Actions workflow -->
            <div>
              <div class="mb-3">
                <p class="text-sm font-medium">1. Trigger from CI</p>
                <p class="text-xs text-muted-foreground mt-0.5">Build your image and call RollHook in the same workflow step.</p>
              </div>
              <div class="rounded-lg border border-border/60 bg-muted/20 overflow-hidden">
                <div class="flex items-center gap-2 px-4 py-3 border-b border-border/40">
                  <div class="flex gap-1.5">
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                  </div>
                  <span class="text-xs text-muted-foreground ml-2">.github/workflows/deploy.yml</span>
                </div>
                <Code code={workflowCode} lang="yaml" theme="github-dark" class="m-0 p-2 md:p-5 text-sm leading-relaxed" />
              </div>
            </div>

            <!-- 2: RollHook config -->
            <div>
              <div class="mb-3">
                <p class="text-sm font-medium">2. Register your app</p>
                <p class="text-xs text-muted-foreground mt-0.5">Point RollHook at the compose file and list the services to roll out.</p>
              </div>
              <div class="rounded-lg border border-border/60 bg-muted/20 overflow-hidden">
                <div class="flex items-center gap-2 px-4 py-3 border-b border-border/40">
                  <div class="flex gap-1.5">
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                  </div>
                  <span class="text-xs text-muted-foreground ml-2">rollhook.config.yaml</span>
                </div>
                <Code code={configCode} lang="yaml" theme="github-dark" class="m-0 p-5 text-sm leading-relaxed" />
              </div>
            </div>

            <!-- 3: App compose.yml -->
            <div>
              <div class="mb-3">
                <p class="text-sm font-medium">3. Add a healthcheck — that's it</p>
                <p class="text-xs text-muted-foreground mt-0.5">Works with Caddy, Traefik, nginx, or any proxy. Docker's internal DNS handles the rest.</p>
              </div>
              <div class="rounded-lg border border-border/60 bg-muted/20 overflow-hidden">
                <div class="flex items-center gap-2 px-4 py-3 border-b border-border/40">
                  <div class="flex gap-1.5">
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                    <div class="h-3 w-3 rounded-full bg-muted-foreground/30"></div>
                  </div>
                  <span class="text-xs text-muted-foreground ml-2">compose.yml</span>
                </div>
                <Code code={composeCode} lang="yaml" theme="github-dark" class="m-0 p-5 text-sm leading-relaxed" />
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Features -->
      <section class="px-6 py-20 border-t border-border/40">
        <div class="max-w-5xl mx-auto">
          <h2 class="text-2xl font-semibold text-center mb-12">What it handles</h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="rounded-lg border border-border/60 bg-muted/10 p-5 space-y-2 hover:bg-muted/20 transition-colors">
              <p class="text-sm font-semibold uppercase tracking-wider">Webhook-Driven</p>
              <p class="text-sm text-muted-foreground leading-relaxed">POST /deploy/:app from any CI pipeline. Admin + webhook token roles.</p>
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/10 p-5 space-y-2 hover:bg-muted/20 transition-colors">
              <p class="text-sm font-semibold uppercase tracking-wider">Rolling Updates</p>
              <p class="text-sm text-muted-foreground leading-relaxed">docker-rollout replaces containers one at a time, healthcheck-gated.</p>
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/10 p-5 space-y-2 hover:bg-muted/20 transition-colors">
              <p class="text-sm font-semibold uppercase tracking-wider">Real-Time Logs</p>
              <p class="text-sm text-muted-foreground leading-relaxed">SSE stream delivers every log line to CI as it happens.</p>
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/10 p-5 space-y-2 hover:bg-muted/20 transition-colors">
              <p class="text-sm font-semibold uppercase tracking-wider">Job History</p>
              <p class="text-sm text-muted-foreground leading-relaxed">SQLite-backed, no external dependencies. Query status and logs any time.</p>
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/10 p-5 space-y-2 hover:bg-muted/20 transition-colors">
              <p class="text-sm font-semibold uppercase tracking-wider">YAML Config</p>
              <p class="text-sm text-muted-foreground leading-relaxed">Configure apps, compose paths, and notification targets in one file.</p>
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/10 p-5 space-y-2 hover:bg-muted/20 transition-colors">
              <p class="text-sm font-semibold uppercase tracking-wider">Notifications</p>
              <p class="text-sm text-muted-foreground leading-relaxed">Pushover + configurable webhook on job completion.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- How it works -->
      <section id="how-it-works" class="px-6 py-20 border-t border-border/40">
        <div class="max-w-2xl mx-auto">
          <h2 class="text-2xl font-semibold text-center mb-12">What happens on deploy</h2>
          <ol class="space-y-6">
            <li class="flex gap-5">
              <span class="shrink-0 font-mono text-xs text-muted-foreground/60 pt-1 w-8">01</span>
              <div class="space-y-1">
                <p class="font-medium text-sm">CI pushes image, sends POST /deploy/my-api</p>
                <p class="text-sm text-muted-foreground">Webhook body carries <code class="text-xs bg-muted/40 px-1 rounded">&#123;"image_tag": "..."&#125;</code> &mdash; CI blocks until deployment completes. Returns HTTP 500 on failure.</p>
              </div>
            </li>
            <li class="flex gap-5">
              <span class="shrink-0 font-mono text-xs text-muted-foreground/60 pt-1 w-8">02</span>
              <div class="space-y-1">
                <p class="font-medium text-sm">compose_path validated, image pulled</p>
                <p class="text-sm text-muted-foreground">Checks that the compose file exists on disk, then pulls the new image from your registry.</p>
              </div>
            </li>
            <li class="flex gap-5">
              <span class="shrink-0 font-mono text-xs text-muted-foreground/60 pt-1 w-8">03</span>
              <div class="space-y-1">
                <p class="font-medium text-sm">docker rollout replaces containers one at a time</p>
                <p class="text-sm text-muted-foreground">New container starts alongside the old one. Traffic continues to the old instance.</p>
              </div>
            </li>
            <li class="flex gap-5">
              <span class="shrink-0 font-mono text-xs text-muted-foreground/60 pt-1 w-8">04</span>
              <div class="space-y-1">
                <p class="font-medium text-sm">Each step waits for healthcheck to pass</p>
                <p class="text-sm text-muted-foreground">Old container removed only after the new one passes its healthcheck. No traffic loss.</p>
              </div>
            </li>
            <li class="flex gap-5">
              <span class="shrink-0 font-mono text-xs text-muted-foreground/60 pt-1 w-8">05</span>
              <div class="space-y-1">
                <p class="font-medium text-sm">Full log stream via SSE; Pushover fires on completion</p>
                <p class="text-sm text-muted-foreground">CI tails the log stream in real time. Notification sent with full job result on finish.</p>
              </div>
            </li>
          </ol>
        </div>
      </section>

      <!-- API Surface -->
      <section class="px-6 py-20 border-t border-border/40">
        <div class="max-w-2xl mx-auto">
          <h2 class="text-2xl font-semibold text-center mb-12">API Surface</h2>
          <div class="rounded-lg border border-border/60 bg-muted/20 overflow-hidden">
            <pre class="p-5 text-sm font-mono leading-relaxed overflow-x-auto"><code><span class="text-green-400">POST  </span><span class="text-foreground/80">/deploy/:app        </span><span class="text-muted-foreground"># Trigger a deployment</span>
<span class="text-blue-400">GET   </span><span class="text-foreground/80">/jobs/:id           </span><span class="text-muted-foreground"># Job status + metadata</span>
<span class="text-blue-400">GET   </span><span class="text-foreground/80">/jobs/:id/logs      </span><span class="text-muted-foreground"># SSE log stream</span>
<span class="text-blue-400">GET   </span><span class="text-foreground/80">/jobs               </span><span class="text-muted-foreground"># Deployment history</span>
<span class="text-blue-400">GET   </span><span class="text-foreground/80">/registry           </span><span class="text-muted-foreground"># Apps + last deploy</span>
<span class="text-yellow-400">PATCH </span><span class="text-foreground/80">/registry/:app      </span><span class="text-muted-foreground"># Update app config</span>
<span class="text-blue-400">GET   </span><span class="text-foreground/80">/health             </span><span class="text-muted-foreground"># Health check (no auth)</span></code></pre>
          </div>
        </div>
      </section>

      <!-- Coming Soon -->
      <section class="px-6 py-16 border-t border-border/40">
        <div class="max-w-2xl mx-auto">
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <div class="border border-border/40 border-dashed rounded-lg px-5 py-3 text-sm text-muted-foreground text-center">
              Deployment monitoring dashboard &mdash; coming soon
            </div>
            <div class="border border-border/40 border-dashed rounded-lg px-5 py-3 text-sm text-muted-foreground text-center">
              Multi-VPS support &mdash; coming soon
            </div>
          </div>
        </div>
      </section>

      <!-- CTA -->
      <section class="px-6 py-24 border-t border-border/40 text-center">
        <div class="max-w-xl mx-auto space-y-6">
          <h2 class="text-3xl font-bold tracking-tight">One curl command away.</h2>
          <p class="text-muted-foreground">
            Add RollHook to your infra compose stack, configure your apps in
            <code class="text-xs bg-muted/40 px-1.5 py-0.5 rounded">rollhook.config.yaml</code>,
            and add the deploy step to your CI workflow.
          </p>
          <a
            href="https://github.com/jkrumm/rollhook"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 rounded-md bg-foreground text-background px-6 py-3 text-sm font-medium hover:bg-foreground/90 transition-colors"
          >
            Read the docs on GitHub
          </a>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="border-t border-border/40 px-6 py-8">
      <div class="max-w-5xl mx-auto flex items-center justify-between text-sm text-muted-foreground">
        <span>RollHook by Johannes Krumm &copy; 2026</span>
        <a
          href="https://github.com/jkrumm/rollhook"
          target="_blank"
          rel="noopener noreferrer"
          class="hidden sm:block hover:text-foreground transition-colors"
        >
          github.com/jkrumm/rollhook
        </a>
      </div>
    </footer>
  </div>
</Layout>
